##Buntster's Tomato Router Management System (BTRMS)##

*Copyright (c) 2014, 2015 Chris A. Bunt*

*All Rights Reserved*

*Distributed under the terms of the MIT License. See "LICENSE" for details*

**Introduction**

Buntster's Tomato Router Management System (BTRMS) is an automated tool for the backup and restoration of Shibby’s Tomato 
router configurations. The BTRMS backup methodology differs from the onboard backup tool in that it builds an executable 
shell script file that restores system parameters line-by-line, rather than taking a snapshot "image" of the router's 
firmware. Doing so makes possible the removal of certain hardware-specific parameters (or any chosen parameters) from the
configuration, allowing the successful restoration or migration of a configuration, even to a physically different router.

The tool has an option to allow certain modifications to an already-existing configuration, saving the changes to a separate
script. This allows for the building of a generalized "base" configuration, and then "patching" site or endpoint-specific 
parameters for the target device. This is useful for multi-unit and/or multi-site rollouts where most of the core configurations
are the same, parameters such as hostnames, subnets, DHCP ranges, domain names, etc. differ.

The final script generated by the BTRMS is self-contained and robust. It will completely clear the target router's nvram, perform
a two-stage, line-by-line restoration of all parameters, pause to ensure the NVRAM environment "catches up" before committing and
finally terminate in a reboot. The process takes about two minutes start to finish, and requires only shell access to the target
device. It has even been used successfully to modify off-site equipment.

**Installing the BTRMS on your router**

Download or copy the tarball to the directory of your choice. 

Note: Although actually copying a file onto your router’s filesystem from another environment is outside the scope of this 
document, note that the two easiest ways to get the tarball onto the router are via USB drive and through a SAMBA mount of 
either the /jffs or /tmp directories.

Extract the tarball to the writable directory of your choice. Keep in mind that these routers operate on mostly read-only 
filesystems, so /tmp, /root, or /jffs are the best places onboard the router. An external USB drive works well, as do externally
mounted filesystems.

Extract the tarball:

`tar xzf foo.tar.gz`

Make the file “transfersetting.sh” executable:

`chmod +x ./transfersettings.sh`

Note that as of the current version of the tool, only the transfersettings.sh file is necessary, the rest of the tarball is
documentation, so if you wish to copy only transfersettings.sh to the working directory, this is sufficient. 

**Backing up your router with BTRMS**

Creating backups or restoration scripts:

`./transfersettings.sh [export|modify] [filename]`

OPTIONS:

`export` – Exports current nvram configuration into a portable restoration script for backup or settings transfer to a 
hardware-identical router.

`modify` – in direct mode (default), creates a portable restoration in export mode, then prompts the user for direct 
modifications to several key parameters and merges these changes into a new restoration script. Passing filename performs 
these modifications to the specified file, rather than against the running configuration.

**Restoring your router's configuration with BTRMS**

`./transfersettings.sh export`

Will export all current settings from the router’s nvram, remove a few troublesome parameters to allow the direct transfer of 
settings between routers, and will then create a restoration script to restore your router to its current configuration or transfer 
its settings directly to another functionally identical unit.

The output file will be in a directory, usually under the working directory, named the same as your router’s hostname. 
The naming convention is:

 `yyyy-mm-dd-hhmm_hostname_fwver.sh`
 
where “hostname” is your router’s hostname, and “fwver” is the firmware version.

The resulting srcipt is self-contained and ready to use. Note that it will contain plaintext (unencrypted) copies of passwords,
public/private key entries or other security-sensitive configurations on the router, and must be protected as such. 

**Restoring your router's configuration with BTRMS**

Simply copy the generated script file to the target router, make it executable and execute it. The script will erase the current
configuration, and place the stored configuration onto the target router. It will then reboot the unit under the new configuration.

You will be reminded that any existing configuration on the target router will be permanently deleted, and if the firmware on the
target router differs from the saved configuration, you will be notified of the mismatch.

The restoration method is destructive in the sense that it will erase all configurations on the target router prior to 
re-writing the configuration. 

**Modifying a BTRMS configuration**

The BTRMS tool is capable of modifying various parameters of its output scripts. This can be done in either of two ways: 
modifying the existing router’s configuration prior to writing the final script, or modifying a previously written script 
and saving the new configuration in a separate file.

*To modify the existing router’s configuration and export a script:*

`./transfersettings.sh modify`

*To modify a previously stored configuration script:*

`./transfersettings.sh modify` *filename*


If the modify option is given without a filename, the BTRMS exports the router’s current configuration. If *filename* is passed, 
the specified file is loaded for modification. The user will then be given the opportunity to modify certain parameters. The 
interface displays the parameter to change, and provides the current setting as a default. 

`lan_ipaddr=["192.168.10.3"]: nul`

Pressing the enter key accepts the default. Should you wish to “blank” the parameter, simply enter nul to clear the parameter’s
configuration as in the example above. 

Modified parameters are then merged into the original configuration and written out to a new script.

The original and modified output files will be in a directory, usually under the working directory, named the same as your router’s
hostname. The naming convention is:

`yyyy-mm-dd-hhmm_hostname_fwver.sh` (original)

`yyyy-mm-dd-hhmm_hostname_fwver-mod.sh` (modified)

where “hostname” is your router’s hostname, and “fwver” is the firmware version.

The scripts are self-contained and ready to use. Note that it will contain plaintext (unencrypted) copies of passwords, 
public/private key entries or other security-sensitive configurations on the router, and must be protected as such. 

**Automating BTRMS backup tasks USING THE TR-AMS**

The Tomato Router-Automated Maintenance System is the emerging next-generation implementation of the BTRMS tool. It greatly 
simplifies the primary function of the BTRMS tool, specifically that of backing up the configurations of one or more routers. 
Using the TR-AMS tool eliminates the need to manually load the BTRMS tools or any dependencies.

If you only need backup functionality, or wish to automate your backups, or just want a simpler way to use the BTRMS tool, 
take a look at the TR-AMS. The TR-AMS git repository is at https://github.com/cbunt1/TR-AMS. 


